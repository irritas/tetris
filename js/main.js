const COLOR={I:"deepskyblue",L:"blue",J:"orange",O:"yellow",S:"lime",Z:"red",T:"darkviolet"},INITIALTIME=12e4,MINSPEED=100,DIFFICULTY=5;class Block{constructor(){this.type=null,this.orient=0,this.content=[[null,null,null,null],[null,null,null,null],[null,null,null,null],[null,null,null,null]]}rotate(e){"clock"===e?3===this.orient?this.orient=0:this.orient++:0===this.orient?this.orient=3:this.orient--,this.update()}update(){switch(this.orient){case 0:case 1:case 2:case 3:this.content=[[null,null,null,null],[null,null,null,null],[null,null,null,null],[null,null,null,null]]}}}class IBlock extends Block{constructor(){super(),this.type="I",this.content=[[null,null,null,null],["I","I","I","I"],[null,null,null,null],[null,null,null,null]]}update(){switch(this.orient){case 0:case 2:this.content=[[null,null,null,null],["I","I","I","I"],[null,null,null,null],[null,null,null,null]];break;case 1:case 3:this.content=[[null,"I",null,null],[null,"I",null,null],[null,"I",null,null],[null,"I",null,null]]}}}class LBlock extends Block{constructor(){super(),this.type="L",this.content=[[null,null,null,null],["L","L","L",null],["L",null,null,null],[null,null,null,null]]}update(){switch(this.orient){case 0:this.content=[[null,null,null,null],["L","L","L",null],["L",null,null,null],[null,null,null,null]];break;case 1:this.content=[[null,"L","L",null],[null,null,"L",null],[null,null,"L",null],[null,null,null,null]];break;case 2:this.content=[[null,null,null,null],[null,null,"L",null],["L","L","L",null],[null,null,null,null]];break;case 3:this.content=[[null,null,null,null],[null,"L",null,null],[null,"L",null,null],[null,"L","L",null]]}}}class JBlock extends Block{constructor(){super(),this.type="J",this.content=[[null,null,null,null],[null,"J","J","J"],[null,null,null,"J"],[null,null,null,null]]}update(){switch(this.orient){case 0:this.content=[[null,null,null,null],[null,"J","J","J"],[null,null,null,"J"],[null,null,null,null]];break;case 1:this.content=[[null,null,null,null],[null,null,"J",null],[null,null,"J",null],[null,"J","J",null]];break;case 2:this.content=[[null,null,null,null],[null,"J",null,null],[null,"J","J","J"],[null,null,null,null]];break;case 3:this.content=[[null,"J","J",null],[null,"J",null,null],[null,"J",null,null],[null,null,null,null]]}}}class TBlock extends Block{constructor(){super(),this.type="T",this.content=[[null,"T",null,null],["T","T","T",null],[null,null,null,null],[null,null,null,null]]}update(){switch(this.orient){case 0:this.content=[[null,"T",null,null],["T","T","T",null],[null,null,null,null],[null,null,null,null]];break;case 1:this.content=[[null,"T",null,null],[null,"T","T",null],[null,"T",null,null],[null,null,null,null]];break;case 2:this.content=[[null,null,null,null],["T","T","T",null],[null,"T",null,null],[null,null,null,null]];break;case 3:this.content=[[null,"T",null,null],["T","T",null,null],[null,"T",null,null],[null,null,null,null]]}}}class OBlock extends Block{constructor(){super(),this.type="O",this.content=[["O","O",null,null],["O","O",null,null],[null,null,null,null],[null,null,null,null]]}update(){}}class SBlock extends Block{constructor(){super(),this.type="S",this.content=[[null,null,null,null],[null,"S","S",null],["S","S",null,null],[null,null,null,null]]}update(){switch(this.orient){case 0:case 2:this.content=[[null,null,null,null],[null,"S","S",null],["S","S",null,null],[null,null,null,null]];break;case 1:case 3:this.content=[[null,"S",null,null],[null,"S","S",null],[null,null,"S",null],[null,null,null,null]]}}}class ZBlock extends Block{constructor(){super(),this.type="Z",this.content=[[null,null,null,null],["Z","Z",null,null],[null,"Z","Z",null],[null,null,null,null]]}update(){switch(this.orient){case 0:case 2:this.content=[[null,null,null,null],["Z","Z",null,null],[null,"Z","Z",null],[null,null,null,null]];break;case 1:case 3:this.content=[[null,null,"Z",null],[null,"Z","Z",null],[null,"Z",null,null],[null,null,null,null]]}}}let level,speed,lineScore,softScore,hardScore,remain,multiply,score,linesMade,nextBlock,savedBlock,curBlock,board,curX,curY,gameState,levelComplete,pressedKey;const scoreEl=document.getElementById("score-value"),levelEl=document.getElementById("level-value"),linesEl=document.getElementById("lines-value"),remainEl=document.getElementById("remain-value"),lineScoreEl=document.getElementById("line-score"),softScoreEl=document.getElementById("soft-score"),hardScoreEl=document.getElementById("hard-score"),multiplyEl=document.getElementById("multiply"),qButton=document.getElementById("clockwise"),wButton=document.getElementById("save"),eButton=document.getElementById("counter"),aButton=document.getElementById("left"),sButton=document.getElementById("soft"),dButton=document.getElementById("right"),spaceButton=document.getElementById("hard"),beginButton=document.getElementById("begin"),restartButton=document.getElementById("restart"),introElStyle=document.getElementById("intro").style,endElStyle=document.getElementById("end").style,gameElStyle=document.querySelector("main").style,controlsElStyle=document.getElementById("controls").style,bgmCheck=document.getElementById("music"),bgmPlayer=document.getElementById("bg-player"),endScoreEl=document.getElementById("new-score"),highScoreEl=document.getElementById("current-high"),newHighEl=document.getElementById("new-high");function addListen(){window.addEventListener("keydown",pressKey),qButton.addEventListener("mouseover",mouseOver),wButton.addEventListener("mouseover",mouseOver),eButton.addEventListener("mouseover",mouseOver),aButton.addEventListener("mouseover",mouseOver),sButton.addEventListener("mouseover",mouseOver),dButton.addEventListener("mouseover",mouseOver),spaceButton.addEventListener("mouseover",mouseOver),qButton.addEventListener("mousedown",mouseDown),wButton.addEventListener("mousedown",mouseDown),eButton.addEventListener("mousedown",mouseDown),aButton.addEventListener("mousedown",mouseDown),sButton.addEventListener("mousedown",mouseDown),dButton.addEventListener("mousedown",mouseDown),spaceButton.addEventListener("mousedown",mouseDown),qButton.addEventListener("click",rotateCounter),wButton.addEventListener("click",saveBlock),eButton.addEventListener("click",rotateClock),aButton.addEventListener("click",moveLeft),sButton.addEventListener("click",pressS),dButton.addEventListener("click",moveRight),spaceButton.addEventListener("click",hardDrop)}function removeListen(){window.removeEventListener("keydown",pressKey),qButton.removeEventListener("mouseover",mouseOver),wButton.removeEventListener("mouseover",mouseOver),eButton.removeEventListener("mouseover",mouseOver),aButton.removeEventListener("mouseover",mouseOver),sButton.removeEventListener("mouseover",mouseOver),dButton.removeEventListener("mouseover",mouseOver),spaceButton.removeEventListener("mouseover",mouseOver),qButton.removeEventListener("mousedown",mouseDown),wButton.removeEventListener("mousedown",mouseDown),eButton.removeEventListener("mousedown",mouseDown),aButton.removeEventListener("mousedown",mouseDown),sButton.removeEventListener("mousedown",mouseDown),dButton.removeEventListener("mousedown",mouseDown),spaceButton.removeEventListener("mousedown",mouseDown),qButton.removeEventListener("click",rotateCounter),wButton.removeEventListener("click",saveBlock),eButton.removeEventListener("click",rotateClock),aButton.removeEventListener("click",moveLeft),sButton.removeEventListener("click",pressS),dButton.removeEventListener("click",moveRight),spaceButton.removeEventListener("click",hardDrop)}function keyEffectEnable(){qButton.addEventListener("mouseup",mouseUp),wButton.addEventListener("mouseup",mouseUp),eButton.addEventListener("mouseup",mouseUp),aButton.addEventListener("mouseup",mouseUp),sButton.addEventListener("mouseup",mouseUp),dButton.addEventListener("mouseup",mouseUp),spaceButton.addEventListener("mouseup",mouseUp)}function keyEffectDisable(){qButton.removeEventListener("mouseup",mouseUp),wButton.removeEventListener("mouseup",mouseUp),eButton.removeEventListener("mouseup",mouseUp),aButton.removeEventListener("mouseup",mouseUp),sButton.removeEventListener("mouseup",mouseUp),dButton.removeEventListener("mouseup",mouseUp),spaceButton.removeEventListener("mouseup",mouseUp)}function pressS(){softDrop(!0)}function mouseOver(e){e.target.style.backgroundColor="lightgrey",qButton.addEventListener("mouseout",mouseOut),wButton.addEventListener("mouseout",mouseOut),eButton.addEventListener("mouseout",mouseOut),aButton.addEventListener("mouseout",mouseOut),sButton.addEventListener("mouseout",mouseOut),dButton.addEventListener("mouseout",mouseOut),spaceButton.addEventListener("mouseout",mouseOut)}function mouseOut(e){e.target.style.backgroundColor="white",qButton.removeEventListener("mouseout",mouseOut),wButton.removeEventListener("mouseout",mouseOut),eButton.removeEventListener("mouseout",mouseOut),aButton.removeEventListener("mouseout",mouseOut),sButton.removeEventListener("mouseout",mouseOut),dButton.removeEventListener("mouseout",mouseOut),spaceButton.removeEventListener("mouseout",mouseOut)}function mouseDown(e){e.target.style.border="inset lightgrey",keyEffectEnable()}function mouseUp(e){e.target.style.border="outset white",keyEffectDisable(),e.target.blur()}function pressKey(e){switch(keyEffectEnable(),pressedKey=e.keyCode,window.addEventListener("keyup",releaseKey),pressedKey){case 81:rotateCounter(),qButton.style.border="inset lightgrey",qButton.style.backgroundColor="lightgrey";break;case 87:saveBlock(),wButton.style.border="inset lightgrey",wButton.style.backgroundColor="lightgrey";break;case 69:rotateClock(),eButton.style.border="inset lightgrey",eButton.style.backgroundColor="lightgrey";break;case 65:moveLeft(),aButton.style.border="inset lightgrey",aButton.style.backgroundColor="lightgrey";break;case 83:pressS(),sButton.style.border="inset lightgrey",sButton.style.backgroundColor="lightgrey";break;case 68:moveRight(),dButton.style.border="inset lightgrey",dButton.style.backgroundColor="lightgrey";break;case 32:hardDrop(),spaceButton.style.border="inset lightgrey",spaceButton.style.backgroundColor="lightgrey"}}function releaseKey(e){e.keyCode===pressedKey&&(window.removeEventListener("keyup",releaseKey),qButton.style.border="outset white",qButton.style.backgroundColor="white",wButton.style.border="outset white",wButton.style.backgroundColor="white",eButton.style.border="outset white",eButton.style.backgroundColor="white",aButton.style.border="outset white",aButton.style.backgroundColor="white",sButton.style.border="outset white",sButton.style.backgroundColor="white",dButton.style.border="outset white",dButton.style.backgroundColor="white",spaceButton.style.border="outset white",spaceButton.style.backgroundColor="white",keyEffectDisable())}function init(e){if(level=e,levelComplete=!1,speed=1e3-5**(level-1),speed<100&&(speed=100),lineScore=1e3*level,softScore=10*level,hardScore=2*softScore,remain=2+2*level,multiply=level/10+1,1===level){gameState=!0,score=0,linesMade=0,curX=3,curY=0,board=[];for(let e=0;e<20;e++)board.push([null,null,null,null,null,null,null,null,null,null]);randNextBlock(),curBlock=nextBlock,randNextBlock(),savedBlock=new Block}drawCurBlock()}function moveLeft(){return eraseCurBlock(),!!valid(curBlock.content,curY,curX-1)&&(curX--,drawCurBlock(),!0)}function moveRight(){return eraseCurBlock(),!!valid(curBlock.content,curY,curX+1)&&(curX++,drawCurBlock(),!0)}function rotateCounter(){eraseCurBlock(),curBlock.rotate("counter"),valid(curBlock.content,curY,curX)||curBlock.rotate("clock"),drawCurBlock()}function rotateClock(){eraseCurBlock(),curBlock.rotate("clock"),valid(curBlock.content,curY,curX)||curBlock.rotate("counter"),drawCurBlock()}function softDrop(e){return gameState?(eraseCurBlock(),valid(curBlock.content,curY+1,curX)?(curY++,e&&(score+=softScore),drawCurBlock(),0):lockBlock()):0}function hardDrop(){if(gameState)for(;;)if(softDrop(!0))return}function lockBlock(){return score+=hardScore,drawCurBlock(),checkLines(),curX=3,curY=0,curBlock=nextBlock,randNextBlock(),valid(curBlock.content,curY,curX)?(drawCurBlock(),1):(gameState=!1,-1)}function checkLines(){let e=0;for(let l=0;l<board.length;l++)board[l].includes(null)||(e++,board.splice(l,1),board.unshift([null,null,null,null,null,null,null,null,null,null]),l--);score+=Math.floor(e*lineScore*multiply**(e-1)),linesMade+=e,remain-=e,remain<1&&(levelComplete=!0,remain=0),render()}function randNextBlock(){switch(Math.floor(7*Math.random())){case 0:return void(nextBlock=new IBlock);case 1:return void(nextBlock=new LBlock);case 2:return void(nextBlock=new JBlock);case 3:return void(nextBlock=new OBlock);case 4:return void(nextBlock=new SBlock);case 5:return void(nextBlock=new ZBlock);case 6:return void(nextBlock=new TBlock)}}function drawCurBlock(){let e=curY;for(let l=0;l<4;l++){let t=curX;if(e>=0&&e<20)for(let n=0;n<4;n++)t>=0&&t<10&&!board[e][t]&&(board[e][t]=curBlock.content[l][n]),t++;e++}render()}function eraseCurBlock(){let e=curY;for(let l=0;l<4;l++){let t=curX;if(e>=0&&e<20)for(let n=0;n<4;n++)t>=0&&t<10&&curBlock.content[l][n]&&(board[e][t]=null),t++;e++}}function valid(e,l,t){let n=l;for(let l=0;l<4;l++){let o=t;for(let t=0;t<4;t++){if(e[l][t]&&(n<0||n>19||o<0||o>9))return!1;if(e[l][t]&&board[n][o])return!1;o++}n++}return!0}function saveBlock(){savedBlock.type?(tempBlock=nextBlock,nextBlock=savedBlock,savedBlock=tempBlock):(savedBlock=nextBlock,randNextBlock()),render()}function play(e){init(e);const l=setInterval(()=>{if(softDrop(!1)<0||!gameState)return gameOver(),void clearInterval(l);levelComplete&&(clearInterval(l),play(level+1)),render()},speed)}function render(){scoreEl.textContent=score<999999?score:Number.parseFloat(score).toExponential(1),levelEl.textContent=level,linesEl.textContent=linesMade,remainEl.textContent=remain,lineScoreEl.textContent=lineScore,softScoreEl.textContent=softScore,hardScoreEl.textContent=hardScore,multiplyEl.textContent=multiply,nextBlock.content.forEach((e,l)=>{e.forEach((e,t)=>{const n=document.getElementById(`next-${l}-${t}`).style;e?(n.borderColor=COLOR[e],n.backgroundColor=COLOR[e]):(n.borderColor="transparent",n.backgroundColor="transparent")})}),savedBlock.content.forEach((e,l)=>{e.forEach((e,t)=>{const n=document.getElementById(`saved-${l}-${t}`).style;e?(n.borderColor=COLOR[e],n.backgroundColor=COLOR[e]):(n.borderColor="transparent",n.backgroundColor="transparent")})}),board.forEach((e,l)=>{e.forEach((e,t)=>{const n=document.getElementById(`${l}-${t}`).style;e?(n.borderColor=COLOR[e],n.backgroundColor=COLOR[e]):(n.borderColor="transparent",n.backgroundColor="transparent")})})}function startGame(){introElStyle.display="none",endElStyle.display="none",gameElStyle.display="grid",controlsElStyle.display="grid",lsEnable=lsTest(),fetchHighScore(),play(1),beginButton.blur(),restartButton.blur(),addListen()}function gameOver(){removeListen(),gameState=!1,endElStyle.display="block",endScoreEl.textContent=score,lsEnable?(highScoreEl.textContent=highScore,score>highScore?(newHighEl.textContent="New high score!",saveHighScore()):newHighEl.textContent="Better luck next time!"):(highScoreEl.textContent="???",newHighEl.textContent="Cookies disabled!")}let lsEnable,highScore;function lsTest(){try{return localStorage.setItem("test","test"),localStorage.removeItem("test"),!0}catch(e){return!1}}function fetchHighScore(){lsEnable&&(highScore=localStorage.getItem("highScore"),highScore||(highScore=0))}function saveHighScore(){localStorage.setItem("highScore",score)}bgmCheck.addEventListener("change",()=>{bgmPlayer.volume=.01,bgmCheck.checked?bgmPlayer.play():bgmPlayer.pause(),bgmCheck.blur()}),beginButton.addEventListener("click",startGame),restartButton.addEventListener("click",startGame);